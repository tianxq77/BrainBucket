# **时间序列分割FLOSS/FLUSS**

源码地址：[https://sites.google.com/site/onlinesemanticsegmentation/](https://sites.google.com/site/onlinesemanticsegmentation/)

Matrix Profile矩阵剖面在时间序列分割领域的应用

处理单变量时间序列

**超参数**:子序列长度L和分段数k

随后，Eamonn Keogh将该算法扩展至能够处理[多元时间序列](https://zhida.zhihu.com/search?content_id=194430553&content_type=Article&match_order=1&q=%E5%A4%9A%E5%85%83%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97&zhida_source=entity)的分割问题，相关成果并发表在DMKD 2019'的文章《Domain agnostic online semantic segmentation for multi-dimensional time series》上。

## 0\. Matrix Profile用于All-pairs similarity search

Matrix Profile是一种通用的时间序列挖掘工具，其可用于多种用途，包括异常检测（anomaly detection），主题发现（Motif Discovery），分类（Classification）以及分割（segmentation）等等。

- Matrix Profile
    
    给定原始单变量时间序列 T=t1,..,ti,..,tn以及子序列长度 m ，通过Matrix Profile可以得到用于记录每个位置子序列与其最近邻的欧氏距离的 MP 以及记录每个位置子序列的最近邻是谁的 MPIndex 。MP[i]越大，表示与T_{i,m}为最近邻的子序列与其距离越大，即其子序列与其不够相似，合理怀疑i点出现了异常
    

- All-pairs similarity search
    
    是一种常见的算法和数据处理技术，尤其在信息检索、数据挖掘和机器学习中，主要用于查找一组数据中所有元素之间的相似性。其基本任务是计算每一对数据元素之间的相似度，并返回所有符合一定标准的配对。
    

## 1\. 基于Matrix Profile的单变量时间序列分段算法FLUSS

### 1.1 定义

- 弧（Arc）：由子序列指向其最近邻子序列
- 弧曲线AC（Arc Curve）：原时间序列的伴生时间序列，AC[i]表示跨过i点的弧数量，首尾的AC=0
- 理想弧曲线 IAC （Idealized Arc Curve）：完全随机的单变量时间序列的AC，高为$n/2$ 的抛物线
    
- 修正后弧曲线 CAC （Corrected Arc Crossings）：依靠理想弧曲线 IAC 进行补偿,所有值都在0到1的范围，并且端点自然低值的问题也得到了修正[image]

### 1.2 算法

获得原始时间序列的 CAC ，给定k ，查找 CAC 对应的 k 个最低谷值的位置，即可确定 k 个分段点的位置。

通常情况下，一个最低谷值周围的值通常也是低的。为避免这种影响，设置了搜索禁区，在最低谷值周围的搜索禁区中（五倍子序列长度），不得再次搜索最低谷值。

* * *

## 0.摘要

不需要学习参数、不需要数据显性可分段、可处理在线问题

## 1.引言

贡献

- FLOSS（Fast Lowcost Online Semantic Segmentation）
- 32个数据集
- 新的评价指标

## 2\. 背景

时间序列T

子序列Ti，L，从index =i开始的长度为L的子序列

系统S

Matrix Profile

Floss局限性

- 不涉及统计特征：本文处理的是子序列形状变化相似性
- 不处理可以人工检查的数据：本文关注人眼难以辨别的状态变化
- 不是分段线性近似
- 不处理细分领域：本文关注的类似于将书分成章节的结构化内容，不处理依赖于特定领域（例如语音或语言处理）和大量标注数据的内容，如将一个长的音频流分成各个单词或音素（如语音识别）

## 3\. semantic segmentation

### 1\. **输入参数：**

- **MPIndex**：矩阵剖面索引，是时间序列的每个位置的最近邻的索引。它表示了每个时间点对应的最近邻（即，具有最小距离的另一个子序列的索引）。这些索引用于计算**弧曲线（**
- **L**：子序列长度

### 2\. **输出参数：**

- **CAC**：修正弧曲线（Corrected Arc Curve）。

### 3\. **算法步骤：**

#### Step 1: 初始化

```
n = length(MPIndex)
AC = CAC = nnmark = zero initialize array of size n
```

- 计算矩阵剖面索引（MPIndex）长度 **n**，即时间序列的长度。
- 初始化三个数组：`AC`（弧）、`CAC`（修正弧）、`nnmark`（标记数组）。

#### Step 2: 计算标记数组 `nnmark`

```
for i=1:n
    j = MPIndex[i]
    nnmark[min(i,j)] = nnmark[min(i,j)] + 1
    nnmark[max(i,j)] = nnmark[max(i,j)] - 1
end
```

- 迭代每个时间点 **i**，并根据矩阵剖面索引 **MPIndex[i]** 获取对应的 **j**。
- **nnmark[min(i, j)]** 和 **nnmark[max(i, j)]** 分别增加和减少标记值（避免重复计数）。地，`nnmark[i]` 表示从时间点 **i** 出发，未在时间i结束的到弧计数。

#### Step 3: 计算实际弧交叉数 `AC`

```
numArcs = 0
for i=1:n
    numArcs = numArcs + nnmark[i]
    AC[i] = numArcs
end
```

- 通过累加 `nnmark` 数组中的值，`numArcs` 累加了每个时间点 i 之前出现，且未在时间i处结束的弧数（如果弧从i出发，则nums[i]+1,如果弧在nums[i]结束，nums[i]-1,累加则体现了从i前出发，未在i结束的所有弧计数）。











## **FLUSS 算法说明文档**
### **一. 基础知识**
MATLAB 中的 `fft` 函数是计算离散傅里叶变换（DFT）及其逆变换（IFFT）的一种高效工具。该函数可以广泛用于信号处理、图像处理、频域分析等领域。在 MATLAB 中，`fft` 函数是内置的，不需要额外安装任何工具箱即可使用。

### 1. **基本概念：傅里叶变换**
傅里叶变换是将一个时域信号（即信号随时间变化的表现）转换为频域信号（即信号中各频率成分的表现）的数学工具。离散傅里叶变换（DFT）是对离散信号的傅里叶变换，它将时域中的离散信号转换为频域中的离散频谱。

#### DFT 的公式：
对于长度为 `N` 的输入向量 `x[n]`，离散傅里叶变换（DFT）的输出 `X[k]` 是由以下公式给出的：
\[
X(k) = \sum_{n=0}^{N-1} x(n) \cdot e^{-j \cdot 2\pi \cdot \frac{k n}{N}}, \quad k = 0, 1, 2, ..., N-1
\]
其中：
- `x(n)` 是时域信号（输入信号）。
- `X(k)` 是频域信号（频谱）。
- `e^{-j 2\pi k n / N}` 是基于复数指数的旋转因子。

离散傅里叶变换是周期性的，且能有效提取信号中的频率成分。

#### 逆傅里叶变换（IFFT）的公式：
离散傅里叶逆变换（IFFT）公式是将频域信号转换回时域信号：
\[
x(n) = \frac{1}{N} \sum_{k=0}^{N-1} X(k) \cdot e^{j \cdot 2\pi \cdot \frac{k n}{N}}, \quad n = 0, 1, 2, ..., N-1
\]
这与DFT的公式相似，唯一的区别是有一个 `1/N` 的归一化因子。

### 2. **MATLAB 中的 `fft` 函数**
MATLAB 的 `fft` 函数可以非常快速地计算一个离散信号的傅里叶变换，使用的是 Cooley-Tukey 快速傅里叶变换（FFT）算法，能够将计算复杂度从 O(N²) 降低到 O(N log N)，大大提高了计算速度。

### 3. **语法**
#### 1. **`fft(X)`**
```matlab
Y = fft(X);
```
- **输入**：`X` 是一个长度为 `N` 的向量或矩阵。
- **输出**：返回 `X` 的离散傅里叶变换结果 `Y`，`Y` 也是一个长度为 `N` 的向量或矩阵，包含了输入信号的频率成分。

#### 2. **`fft(X, N)`**
```matlab
Y = fft(X, N);
```
- **输入**：
  - `X` 是一个信号向量或矩阵。
  - `N` 是希望计算的傅里叶变换的点数（长度）。
- **输出**：返回 `N` 点的傅里叶变换，如果 `X` 的长度小于 `N`，会在 `X` 的末尾填充零。如果 `X` 的长度大于 `N`，则会截断多余的部分。

#### 3. **`fft(X, [], DIM)` 或 `fft(X, N, DIM)`**
```matlab
Y = fft(X, [], DIM);
Y = fft(X, N, DIM);
```
- **输入**：
  - `DIM` 是指定傅里叶变换操作的维度。例如，`DIM=1` 表示对每列进行傅里叶变换，`DIM=2` 表示对每行进行傅里叶变换。
  - `N` 是傅里叶变换的点数。
- **输出**：对指定维度 `DIM` 上的每个信号进行傅里叶变换，返回傅里叶变换结果。

#### 4. **逆傅里叶变换 `ifft(X)`**
```matlab
X_reconstructed = ifft(Y);
```
- **输入**：`Y` 是一个频域信号，通常是 `fft` 函数的输出。
- **输出**：返回逆傅里叶变换后的时域信号 `X_reconstructed`，它是对频域信号 `Y` 的反变换。

### 4. **详细解释：FFT 的应用**
在实际应用中，`fft` 函数用于从时域信号计算频域信号，或者从频域信号计算时域信号。通过频域信号，能够更容易地分析和处理信号的不同频率成分。

#### 应用场景：
1. **信号分析**：通过傅里叶变换，可以分析一个信号的频率组成。例如，可以用于分析音频信号的频谱、检测周期性成分等。
2. **滤波**：可以通过在频域对信号进行处理（如滤波）来去除某些频率成分，然后通过逆傅里叶变换得到时域信号。
3. **图像处理**：傅里叶变换也广泛用于图像处理，例如，图像压缩、图像增强等。
4. **声学和通信**：傅里叶变换可以用于分析声音信号、通信信号等，帮助识别信号的频率特性。

#### 示例：
1. **计算一个简单信号的傅里叶变换**：
   ```matlab
   x = [1, 2, 3, 4];        % 输入信号
   X = fft(x);               % 计算傅里叶变换
   disp(X);                  % 显示频域信号
   ```

2. **通过傅里叶变换分析信号频率成分**：
   假设你有一个包含多个频率成分的信号，傅里叶变换可以帮助你提取不同频率的成分：
   ```matlab
   t = 0:0.01:1;                 % 时间向量
   x = sin(2*pi*10*t) + sin(2*pi*20*t);  % 10Hz 和 20Hz 的正弦信号
   X = fft(x);                   % 计算傅里叶变换
   f = (0:length(X)-1)*100/length(X);    % 频率向量
   plot(f, abs(X));              % 绘制频谱
   xlabel('Frequency (Hz)');
   ylabel('Magnitude');
   ```

3. **逆傅里叶变换恢复时域信号**：
   ```matlab
   y = ifft(X);                  % 通过逆傅里叶变换恢复时域信号
   disp(y);                       % 显示恢复后的时域信号
   ```

### 5. **FFT 的效率**
- **FFT 的计算复杂度**：传统的离散傅里叶变换计算复杂度是 O(N²)，而 FFT 将计算复杂度降至 O(N log N)，极大地提高了计算效率。
- **应用领域**：FFT 在大数据处理、实时信号处理、图像和音频分析、频谱分析等领域得到了广泛应用。

### 6. **相关函数**
- **`ifft`**：计算逆离散傅里叶变换（IDFT）。
- **`fft2`**：二维傅里叶变换，常用于图像处理。
- **`fftn`**：N维傅里叶变换，适用于高维数据。
- **`fftshift`**：将傅里叶变换后的频谱中心化，使得零频成分显示在频谱的中间位置，常用于频谱图显示。
  
### 总结
MATLAB 的 `fft` 函数通过高效的快速傅里叶变换算法（FFT），使得计算离散傅里叶变换变得快速且方便。无论是对信号进行频域分析、滤波还是进行时域恢复，`fft` 都是一个非常强大的工具。在信号处理、图像处理、通信系统等领域中都有广泛的应用。

傅里叶变换的结果是一个复数向量，它描述了信号在不同频率上的组成情况。通过傅里叶变换，我们将时域信号转换为频域信号，频域信号由两个主要部分构成：

1. **幅度谱（Magnitude Spectrum）**：表示信号中每个频率成分的强度，通常通过复数的模来计算。
2. **相位谱（Phase Spectrum）**：表示每个频率成分的相位信息，通常通过复数的角度来计算。

### 1. **傅里叶变换的概念**
对于一个时域信号 \( x(t) \)，傅里叶变换的结果 \( X(f) \) 是一个复数序列，它的每个元素表示该信号在某个频率分量上的振幅和相位。傅里叶变换可以看作是将一个时域信号分解为若干正弦波的叠加，变换结果为信号在不同频率成分上的强度和相位。

对于离散信号，傅里叶变换（DFT）可以表示为：
\[
X(k) = \sum_{n=0}^{N-1} x(n) \cdot e^{-j \cdot 2\pi \cdot \frac{k \cdot n}{N}}, \quad k = 0, 1, 2, \dots, N-1
\]
其中：
- \( x(n) \) 是时域信号的第 \( n \) 个采样点。
- \( N \) 是信号的长度（即采样点数）。
- \( X(k) \) 是傅里叶变换结果中第 \( k \) 个频率成分的复数表示。

### 2. **傅里叶变换结果的组成**
傅里叶变换的结果通常是一个复数数组，表示信号在不同频率上的振幅和相位。

- **幅度（Magnitude）**：傅里叶变换的每个频率成分 \( X(k) \) 都是一个复数，幅度是该复数的模，表示该频率成分的强度。可以通过 `abs(X(k))` 计算。
  
  \[
  |X(k)| = \sqrt{\Re(X(k))^2 + \Im(X(k))^2}
  \]
  
- **相位（Phase）**：傅里叶变换的每个频率成分 \( X(k) \) 的相位是复数的角度，表示该频率成分的相位偏移。可以通过 `angle(X(k))` 计算。
  
  \[
  \arg(X(k)) = \text{atan2}(\Im(X(k)), \Re(X(k)))
  \]

### 3. **傅里叶变换结果的特点**
- **频率成分**：每个复数 \( X(k) \) 对应一个频率成分，表示信号中该频率成分的幅度和相位。信号的频率范围从 \( 0 \) 到 \( N-1 \)，对应于采样点数和采样间隔。
- **对称性**：对于实值信号，其频域的结果是共轭对称的。即正频率部分与负频率部分是对称的。
- **直流成分**：傅里叶变换的第一个元素（\( X(0) \)）通常是直流成分，表示信号的平均值。
- **奈奎斯特频率**：傅里叶变换的中间位置对应于奈奎斯特频率，即信号中最大的频率成分。

### 4. **傅里叶变换的结果示例**
假设有一个简单的时域信号 \( x = [1, 2, 3, 4] \)，我们对其进行傅里叶变换：

```matlab
x = [1, 2, 3, 4];        % 输入信号
X = fft(x);               % 计算傅里叶变换
disp(X);                  % 显示傅里叶变换结果
```

输出为：

```
10.0000 + 0.0000i   -2.0000 + 2.0000i
-2.0000 + 0.0000i   -2.0000 - 2.0000i
```

### 5. **分析傅里叶变换的结果**
在上述例子中，`X` 的四个元素分别是：
- **`X(1) = 10 + 0i`**：表示信号的直流成分（频率为 0）。它是所有样本的总和，表示信号的平均值。
- **`X(2) = -2 + 2i`**：表示频率为 1 的成分，复数形式表示该频率的幅度和相位。
- **`X(3) = -2 + 0i`**：表示频率为 2 的成分。
- **`X(4) = -2 - 2i`**：表示频率为 3 的成分。

### 6. **如何从傅里叶变换结果中提取信息**
- **幅度谱**：通过 `abs(X)` 计算每个频率成分的幅度（强度），可以看出信号中哪些频率成分比较强。
- **相位谱**：通过 `angle(X)` 计算每个频率成分的相位信息，了解每个频率分量的相位偏移。

### 7. **频域图的可视化**
为了更直观地理解频域信息，可以通过绘制幅度谱和相位谱来观察频率成分。

```matlab
% 计算幅度谱和相位谱
magnitude = abs(X);  % 幅度
phase = angle(X);    % 相位

% 绘制幅度谱
subplot(2,1,1);
stem(magnitude);      % 绘制幅度谱
title('Magnitude Spectrum');
xlabel('Frequency Bin');
ylabel('Magnitude');

% 绘制相位谱
subplot(2,1,2);
stem(phase);         % 绘制相位谱
title('Phase Spectrum');
xlabel('Frequency Bin');
ylabel('Phase (radians)');
```

### 总结
傅里叶变换的结果是一个复数数组，包含信号在不同频率上的频率成分。每个频率成分由复数表示，其模表示信号在该频率上的强度，角度表示该频率的相位偏移。通过傅里叶变换，我们可以了解信号的频率结构，识别信号中存在的周期性成分，以及它们的幅度和相位信息。