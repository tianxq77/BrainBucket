### CKD需求算法文档

#### 1. 概述  

该算法满足需求的前提下优化出库的分配策略，考虑库存时间的同时，最大化需求满足率及最小化分配的超出量。算法有以下核心目标：  

* **目标 1**: 最大化满足需求的个数。 
* **目标 2**: 最小化出库的物料数量与需求数量的差 
* **目标 3**: 优先使用日期较早的库存


---

#### 2. 符号定义  

| **符号**           | **描述**                                                                       |  
|---------------------|-------------------------------------------------------------------------------|  
| **【需求属性】**     |                                                                               |  
| $i$                 | 需求编号，$i=1,2,\cdots,I$                                                   |  
| $PN_i$              | 第 $i$ 个需求的物料编码                                                      |  
| $Q_i$               | 第 $i$ 个需求的数量                                                         |  
| $W_i$               | 第 $i$ 个需求的周次                                                         |  
| $ALT(PN_i)$         | 需求 $PN_i$ 的可替代料号集合                                                |  
| **【库存属性】**     |                                                                               |  
| $j$                 | 库存编号，$j=1,2,\cdots,J$                                                   |  
| $PN_j$              | 第 $j$ 个库存的物料编码                                                      |  
| $Q_j$               | 第 $j$ 个库存的数量                                                         |  
| $Day_j$             | 第 $j$ 个库存的日期                                                         |  
| $Merge_j$           | 第 $j$ 个库存是否为整箱（1 表示 MergeCarton，0 表示单箱 CID）               |  

---

#### 3. 数学模型  

##### 3.1 约束条件  

* **需求满足约束**：每个需求的分配量必须大于等于需求数量才能算作满足需求  

$$  
\sum_{j \in S_i} x_{ij} \geq Q_i, \quad \forall i  
$$  

其中，$x_{ij}$ 表示库存 $j$ 分配给需求 $i$ 的数量，$S_i$ 为需求 $i$ 可用的库存集合。  

* **库存分配约束**：每个库存的分配量不能超过其可用数量  

$$  
\sum_{i=1}^{I} x_{ij} \leq Q_j, \quad \forall j  
$$  

* **替代关系约束**：如果需求的物料不足，可以通过替代料号的库存来满足需求  

$$  
PN_j \in \{PN_i\} \cup ALT(PN_i), \quad \forall i, j \in S_i  
$$  

* **整箱优先分配约束**：优先分配 `MergeCarton` 的库存，其次分配单箱库存  

---

##### 3.2 目标函数  

**目标 1：最大化满足需求的个数**  

$$  
f_1 = \max \left( \sum_{i=1}^{I} z_i \right)  
$$  

其中，$z_i$ 表示需求 $i$ 是否被完全满足：  

$$  
z_i =  
\begin{cases}  
1, & \text{如果 } \sum_{j \in S_i} x_{ij} \geq Q_i \\  
0, & \text{否则}  
\end{cases}  
$$  

**目标 2：最小化出库物料数量与需求数量的偏差**  

$$  
f_2 = \min \left( \sum_{i=1}^{I} \sum_{j \in S_i} |x_{ij} - Q_i| \right)  
$$  

**目标 3：最小化出库的日期偏差**  

$$  
f_3 = \min \left( \sum_{i=1}^{I} \sum_{j \in S_i} Day_j \cdot x_{ij} \right)  
$$  

---

#### 4. 核心步骤  

##### 4.1 数据预处理  

1. 按需求的 `W_i`（周次）升序排序，确保优先满足时间更紧急的需求。  
2. 按库存的以下规则排序：  
   - 优先级 1：`MergeCarton` > 单箱库存。  
   - 优先级 2：日期 (`Day_j`) 从小到大。  
   - 优先级 3：库存数量 (`Q_j`) 从大到小。  

---

##### 4.2 分配逻辑  

###### **Step 1: 普通分配**  

1. 遍历每个需求 $i$：  
   * 查找库存中匹配该需求物料 $PN_i$ 的 `MergeCarton`：  
     - 如果库存数量 $Q_j$ 足够满足需求 $Q_i$，则直接分配；  
     - 如果不足，则继续尝试分配其他库存的 `MergeCarton`；  
   * 如果没有 `MergeCarton`，尝试使用单箱库存满足需求。  

2. 更新库存状态，标记已分配的库存。  

###### **Step 2: 替代分配**  

1. 如果普通分配无法满足需求，尝试使用需求的替代料号集合 $ALT(PN_i)$：  
   * 遍历替代料号集合，对可用库存进行分配。  
   * 替代分配的优先级与普通分配一致：`MergeCarton` > 单箱库存，FIFO 优先。  

2. 更新库存状态，标记已分配的库存。  

###### **Step 3: 结果生成**  

1. 对于每个需求，记录满足情况和分配的库存：  
   * 如果需求被完全满足，记录 `type` 和 `carton_id`；  
   * 如果需求未被满足，记录空结果。  

2. 生成最终分配结果。  

---

#### 5. 算法流程  

```plaintext
1. 输入需求和库存数据；
2. 对需求按周次优先级进行排序；
3. 对库存按 MergeCarton、日期、数量进行排序；
4. 初始化结果集；
5. 遍历每个需求：
    a. 普通分配：
        - 尝试分配匹配的库存；
        - 更新库存状态；
    b. 替代分配：
        - 如果普通分配无法满足需求，尝试使用替代料号的库存；
        - 更新库存状态；
6. 生成分配结果；
7. 输出结果。
```

---

#### 6. 示例  

##### 输入  

```json  
{  
    "site": "site01",  
    "demands": [  
        {  
            "id": 1,  
            "pn": "pn01",  
            "week": 3,  
            "quantity": 100,  
            "alt_pn": ["pn02", "pn03"]  
        }  
    ],  
    "stocks": [  
        {  
            "cid": "cid01",  
            "pn": "pn01",  
            "mergeCarton": "carton01",  
            "day": 10,  
            "quantity": 100  
        },  
        {  
            "cid": "cid02",  
            "pn": "pn02",  
            "mergeCarton": "",  
            "day": 5,  
            "quantity": 50  
        }  
    ]  
}  
```  

##### 输出  

```json  
{  
    "site": "site01",  
    "result": [  
        {  
            "demand_id": 1,  
            "detail": [  
                {  
                    "type": 2,  
                    "carton_id": "carton01"  
                }  
            ]  
        }  
    ]  
}  
```  

---

#### 7. 总结  

该算法通过优先级排序、整箱优先分配和替代策略，最大化了需求满足率，并最小化了出库偏差和时间成本。在满足需求的同时，算法遵循了 FIFO 原则，确保库存被合理使用，减少浪费。