### CKD出货建议算法文档

---
#### 1. 概述

本算法旨在解决 CKD (全散件)需求的库存分配问题，通过合理分配库存，最大化满足需求量，最小化出库超出量，并综合考虑库存时间和合箱约束的限制。
每个 site 作为一个独立的出货单元，不同 site 之间的需求和库存不共享。主要优化目标包括：

1. 最大化需求满足率，尽可能满足更多的需求

2. 最小化大箱（存在混箱PN情况下）出库料号数量,降低库存浪费

3. 最小化出货超出量,提高库存利用率

4. 优先使用早期库存，降低库存老化风险
   
通过建立混合整数规划模型，在满足约束条件的前提下，优化出库计划。

---
#### 2. 问题描述
**库存类型**
- 库存分为小箱、大箱
  - 小箱不可拆分，需整箱出库
  - 大箱由多个小箱组成，同一site内可共享

**需求分配规则**
- 严格按照周次顺序分配需求，前序周需求未满足时，后续周次的需求也不会被分配


---
#### 3. 数学模型
##### 3.1 符号说明

| 符号         | 描述                                                                    |
|:-----------|:----------------------------------------------------------------------|
| **【需求属性】** |                                                                       |
| $i$        | 需求编号，$i=1,2,\cdots,I$                                                 |
| $H_i$      | 需求 $i$ 的料号及替代组，$H_i = \{h_1, h_2, \cdots, h_n\}$                      |
| $Q_i$      | 需求 $i$ 的物料需求量                                                         |
| $W_i$      | 需求 $i$ 的周次                                                            |
| **【库存属性】** |                                                                       |
| $s$        | 库存（小箱）编号，$s=1,2,\cdots,S$                                             |
| $p_s$      | 小箱 $s$ 的料号                                                            |
| $q_s$      | 小箱 $s$ 的物料数量                                                          |
| $d_s$      | 小箱 $s$ 的入库日期                                                          |
| $m_s$      | 小箱 $s$ 的合箱号,$m_s = c$ 表示 $s$ 属于大箱 $c$（为空表示未合箱）                        |
| $c$        | 大箱编号，$c=1,2,\cdots,C$                                                 |
| $pn_c$     | 大箱中料号数量                                                               |
| **【决策变量】** |                                                                       |
| $x_{i,s}$  | $x_{i,s} \in \{0, 1\}$, 是否使用小箱子 $s$ 满足需求 $i$ ,$x_{i,s}= 1$ 表示使用，否则为 0 |
| $y_i$      | $y_i \in \{0, 1\}$, 需求 $i$ 是否被满足  ,  $y_i= 1$ 表示满足，否则为 0              |
| $z_{c}$    | $z_{c} \in \{0, 1\}$, 是否使用大箱 $c$, $z_{c} = 1$ 表示使用，否则为 0              |
##### 3.2 约束条件

1. **需求满足约束**：

    * 每个需求 $i$ 的出货总量要么必须完全满足其需求量 $Q_i$，要么不满足

      $$
      \sum_{s \in S: p_s \in H_i} x_{i,s} \cdot q_s \geq y_i \cdot Q_i \quad \forall i \in I
      $$

    * 严格按照周次分配，前序周需求未满足时，后续周次需求不分配
   
      $$
      y_j\leq  y_i \quad \forall i,j \in I,W_j > W_i
      $$


2. **小箱出库约束**：

    * 每个小箱 $s$ 只能分配给一个需求

      $$
      \sum_{i \in I} x_{i,s} \leq 1 \quad \forall s \in S
      $$

3. **大箱出库约束**：

    * 如果小箱 $s$ 出库，则其所属大箱 $c$ 必须出库

      $$
      x_{i,s} \leq z_{c} \quad \forall c \in C, m_s = c,i \in I
      $$

##### 3.3 目标函数

采用加权多目标优化，将各目标函数通过加权求和转化为单个优化目标求解

$$
\min \left( \alpha_1 f_1 + \alpha_2 f_2 + \alpha_3 f_3 + \alpha_4f_4 \right)
$$

1. **最大化需求的满足数量**：
   优先满足更多的需求，最小化未满足的需求量

   $$
   f_1 = I-\sum_{i \in I} y_i
   $$

2. **最小化混箱PN超出类型量**：
   减少分配的大箱中的料号个数

   $$
   f_2 = \sum_{c \in C} z_{c} \cdot pn_c
   $$

3. **最小化物料超出量**：
   减小分配的出货量超出需求量的物料数量
   $$
   f_3 = \left( \sum_{s \in S: m_s = \emptyset} \sum_{i \in I} x_{i,s} \cdot q_s + \sum_{c \in C} z_{c} \cdot \sum_{s \in S: m_s = c} q_s \right) - \sum_{i \in I} y_i \cdot Q_i
   $$

4. **最小化出库物料的库存日期**：
   优先使用较早的库存

   $$
   f_4 = \sum_{s \in S} \sum_{i \in I} x_{i,s} \cdot d_s
   $$

**权重设置**

权重系数的设置是多目标优化中的关键环节，需要根据数据规模动态调整
1. **量纲对齐**

   实时计算当前问题的目标范围,动态缩放, 保证目标函数的量纲一致性,获取对齐后的目标函数

   | 目标函数       | 原始范围                 | 归一化范围 |
   |----------------|----------------------|------------|
   | $f_1$（未满足需求） | 0~$I$                | 0~1        |
   | $f_2$（混箱料号）  | 0~ $C \cdot pn_c$    | 0~1        |
   | $f_3$（物料超出量） | 0~$max(Q_i) $        | 0~1        |
   | $f_4$（库存日期）  | 0~$S \cdot max(d_s)$ | 0~1        |


2. **业务优先级权重**

   | 目标函数       | 业务优先级 | 归一化后权重 |
   |----------------|------------|--------------|
   | $f_1$          | 最高       | 1000          |
   | $f_2$          | 高         | 100           | 
   | $f_3$          | 中         | 10            |
   | $f_4$          | 低         | 1             | 

3.  **验证和调整**

   通过测试数据模拟不同的权重组合，观察优化结果，确定合理的权重值


---
#### 4. 总结

本算法通过混合整数规划模型，将需求、库存和合箱约束全面建模，结合多目标优化方法，实现了需求满足率、库存分配、混箱约束的全局优化。

#### 注：

1. 大箱库存分配不直接关联到需求，而是关联到site层级。

2. 需求层按小箱分配。

